<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notice - æ¶ˆæ¯ä¸­å¿ƒ</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Noto+Sans+SC:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent: #00d4aa;
            --accent-dim: #00d4aa33;
            --text-primary: #e8e8e8;
            --text-secondary: #888;
            --border: #2a2a3a;
            --success: #00d4aa;
            --error: #ff4757;
            --warning: #ffa502;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            background-image:
                radial-gradient(ellipse at top left, #00d4aa08 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, #6366f108 0%, transparent 50%);
        }

        /* å…¨å±å®¹å™¨ */
        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨æ  */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 1rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.6rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .server-stats {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* è®¤è¯åŒºåŸŸ */
        .auth-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-card {
            width: 100%;
            max-width: 360px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .auth-card h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .main-content.active {
            display: flex;
        }

        /* æ ‡ç­¾é¡µå¯¼èˆª - æ›´ç´§å‡‘ */
        .tabs {
            display: flex;
            gap: 0;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* æ ‡ç­¾å†…å®¹ */
        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* è¿æ¥æ  - å†…è”ç´§å‡‘ */
        .connection-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .connection-bar input {
            flex: 1;
            min-width: 0;
            padding: 0.4rem 0.6rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .connection-bar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .connection-bar input::placeholder {
            color: var(--text-secondary);
        }

        .connection-bar label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            background: var(--bg-card);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 6px var(--success);
        }

        /* æ¶ˆæ¯å¤´ */
        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            gap: 0.5rem;
        }

        .messages-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .messages-header .meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            line-height: 1;
        }

        /* æ¶ˆæ¯åˆ—è¡¨ - å æ»¡å‰©ä½™ç©ºé—´ */
        .messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .message-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.4rem;
            animation: slideIn 0.2s ease;
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .message-item.selected {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .message-body {
            flex: 1;
            min-width: 0;
        }

        /* è‡ªå®šä¹‰ Checkbox æ ·å¼ */
        .custom-checkbox {
            position: relative;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
        }

        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            margin: 0;
        }

        .custom-checkbox .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            width: 18px;
            height: 18px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .custom-checkbox:hover .checkmark {
            border-color: var(--accent);
        }

        .custom-checkbox input:checked~.checkmark {
            background: var(--accent);
            border-color: var(--accent);
        }

        .custom-checkbox .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 50%;
            top: 45%;
            width: 4px;
            height: 8px;
            border: solid var(--bg-primary);
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .custom-checkbox input:checked~.checkmark:after {
            display: block;
        }

        /* å…¨é€‰æ ‡ç­¾æ ·å¼ */
        .select-all-label {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            white-space: nowrap;
            color: inherit;
            padding: 0.25rem 0;
        }

        .select-all-label:hover {
            color: var(--text-primary);
        }

        .select-all-label .custom-checkbox {
            width: 12px;
            height: 12px;
            margin: 0;
            overflow: visible;
        }

        .select-all-label .checkmark {
            width: 12px;
            height: 12px;
            border-width: 1px;
        }

        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 360px;
            width: 100%;
            text-align: center;
        }

        .confirm-dialog h4 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .confirm-dialog p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 1.25rem;
        }

        .confirm-dialog .btn-group {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        .confirm-dialog .btn-group button {
            min-width: 80px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .message-title {
            font-weight: 600;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .message-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .message-content {
            color: var(--text-primary);
            line-height: 1.4;
            font-size: 0.85rem;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .message-topic {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.75rem;
            opacity: 0.3;
        }

        /* å‘é€æ¶ˆæ¯é¢æ¿ */
        .send-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: auto;
        }

        .send-form {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-row {
            display: flex;
            gap: 0.75rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        textarea {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Noto Sans SC', sans-serif;
        }

        /* æŒ‰é’® */
        button,
        .btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        button:hover,
        .btn:hover {
            filter: brightness(1.1);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        button.danger {
            background: var(--error);
        }

        button.small {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        button.full {
            width: 100%;
        }

        /* å“åº”æ¡† */
        .response-box {
            margin-top: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            display: none;
        }

        .response-box.success {
            border-color: var(--success);
        }

        .response-box.error {
            border-color: var(--error);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.85rem;
            animation: slideIn 0.2s ease;
            z-index: 1000;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--error);
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 480px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.2s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.1rem;
            background: linear-gradient(135deg, var(--accent), #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.25rem;
        }

        .help-section {
            margin-bottom: 1.25rem;
        }

        .help-section h4 {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .help-section ul {
            list-style: none;
            font-size: 0.85rem;
        }

        .help-section li {
            padding: 0.3rem 0;
            color: var(--text-primary);
        }

        .code-block {
            display: block;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent);
            white-space: pre-wrap;
            word-break: break-all;
        }

        .help-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .help-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .help-link:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .help-footer {
            display: flex;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* å“åº”å¼ */
        @media (max-width: 640px) {
            .topbar {
                padding: 0.5rem;
            }

            .server-stats {
                display: none;
            }

            .connection-bar {
                flex-wrap: wrap;
            }

            .connection-bar input {
                flex: 1 1 100%;
            }

            .connection-bar input:first-of-type {
                flex: 2;
            }

            .connection-bar input:last-of-type {
                flex: 1;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- é¡¶éƒ¨æ  -->
        <div class="topbar">
            <div class="logo">ğŸ“¡ Notice</div>
            <div class="topbar-right" id="topbarRight" style="display: none;">
                <div class="server-stats" id="serverStats"></div>
                <div class="user-badge">
                    <span>ğŸ”‘</span>
                    <span id="tokenDisplay">-</span>
                </div>
                <button class="secondary small" onclick="showHelp()">å¸®åŠ©</button>
                <button class="secondary small" onclick="logout()">é€€å‡º</button>
            </div>
        </div>

        <!-- ç¡®è®¤å¯¹è¯æ¡† -->
        <div class="modal-overlay" id="confirmModal" onclick="hideConfirm(event)">
            <div class="confirm-dialog" onclick="event.stopPropagation()">
                <h4 id="confirmTitle">ç¡®è®¤æ“ä½œ</h4>
                <p id="confirmMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div class="btn-group">
                    <button class="secondary" onclick="hideConfirm()">å–æ¶ˆ</button>
                    <button class="danger" id="confirmBtn" onclick="executeConfirm()">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <!-- å¸®åŠ©å¼¹æ¡† -->
        <div class="modal-overlay" id="helpModal" onclick="hideHelp(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>ğŸ“¡ Notice</h3>
                    <button class="modal-close" onclick="hideHelp()">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="modal-desc">è½»é‡çº§æ¶ˆæ¯æ¨é€æœåŠ¡ï¼Œé›†æˆ HTTP Webhook å’Œ MQTT Broker</p>

                    <div class="help-section">
                        <h4>åŠŸèƒ½ç‰¹æ€§</h4>
                        <ul>
                            <li>ğŸ“¥ HTTP Webhook æ¥æ”¶æ¶ˆæ¯</li>
                            <li>ğŸ“¡ å†…ç½® MQTT Broker (TCP + WebSocket)</li>
                            <li>ğŸ” Token è®¤è¯</li>
                            <li>ğŸ’¾ ç¦»çº¿æ¶ˆæ¯æ”¯æŒ</li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h4>API ä½¿ç”¨</h4>
                        <code class="code-block">curl -X POST /webhook \
  -H "Authorization: Bearer &lt;token&gt;" \
  -d '{"title":"æ ‡é¢˜","content":"å†…å®¹"}'</code>
                    </div>

                    <div class="help-section">
                        <h4>é¡¹ç›®é“¾æ¥</h4>
                        <div class="help-links">
                            <a href="https://github.com/i2534/notice" target="_blank" class="help-link">
                                <span>ğŸ“¦</span> GitHub ä»“åº“
                            </a>
                            <a href="https://github.com/i2534/notice/issues" target="_blank" class="help-link">
                                <span>ğŸ›</span> é—®é¢˜åé¦ˆ
                            </a>
                            <a href="https://github.com/i2534/notice/releases" target="_blank" class="help-link">
                                <span>ğŸ“‹</span> ç‰ˆæœ¬å‘å¸ƒ
                            </a>
                        </div>
                    </div>

                    <div class="help-footer">
                        <span>MIT License</span>
                        <span>Â© 2024 Notice Project</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¤è¯åŒºåŸŸ -->
        <div class="auth-section" id="authSection">
            <div class="auth-card">
                <h2>ğŸ” è®¤è¯</h2>
                <div class="form-group">
                    <input type="password" id="authTokenInput" placeholder="è¯·è¾“å…¥è®¤è¯ Token"
                        onkeydown="if(event.key==='Enter')authenticate()">
                </div>
                <button class="full" onclick="authenticate()">éªŒè¯å¹¶è¿›å…¥</button>
                <div class="response-box" id="authResponse"></div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content" id="mainContent">
            <!-- æ ‡ç­¾é¡µ -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('receive')">ğŸ“¥ æ¥æ”¶æ¶ˆæ¯</button>
                <button class="tab-btn" onclick="switchTab('send')">ğŸ“¤ å‘é€æ¶ˆæ¯</button>
            </div>

            <!-- æ¥æ”¶æ¶ˆæ¯æ ‡ç­¾é¡µ -->
            <div class="tab-content active" id="tab-receive">
                <!-- è¿æ¥æ  -->
                <div class="connection-bar">
                    <label>WSåœ°å€</label>
                    <input type="text" id="brokerUrl" placeholder="wss://mqtt.example.com">
                    <label>ä¸»é¢˜</label>
                    <input type="text" id="topic" value="notice/#" style="max-width: 120px;">
                    <div class="status-indicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="statusText">ç¦»çº¿</span>
                    </div>
                    <button id="connectBtn" onclick="toggleConnection()">è¿æ¥</button>
                </div>

                <!-- æ¶ˆæ¯å¤´ -->
                <div class="messages-header">
                    <h3>ğŸ“¨ æ¶ˆæ¯</h3>
                    <div class="meta">
                        <span id="messageCount">0 æ¡</span>
                        <label class="select-all-label" style="white-space: nowrap;">
                            <span class="custom-checkbox">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                <span class="checkmark"></span>
                            </span>
                            å…¨é€‰
                        </label>
                        <button class="secondary small" id="deleteSelectedBtn"
                            onclick="confirmDeleteSelected()">åˆ é™¤é€‰ä¸­</button>
                        <button class="secondary small" onclick="confirmClearMessages()">æ¸…ç©º</button>
                    </div>
                </div>

                <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                <div class="messages-list" id="messagesList">
                    <div class="empty-state" id="emptyState">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>ç­‰å¾…æ¶ˆæ¯...</p>
                    </div>
                </div>
            </div>

            <!-- å‘é€æ¶ˆæ¯æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="tab-send">
                <div class="send-panel">
                    <div class="send-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ ‡é¢˜</label>
                                <input type="text" id="sendTitle" placeholder="æ¶ˆæ¯æ ‡é¢˜">
                            </div>
                            <div class="form-group">
                                <label>ä¸»é¢˜ (å¯é€‰)</label>
                                <input type="text" id="sendTopic" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å†…å®¹</label>
                            <textarea id="sendContent" placeholder="æ¶ˆæ¯å†…å®¹..."></textarea>
                        </div>
                        <button onclick="sendMessage()" id="sendBtn">å‘é€æ¶ˆæ¯</button>
                        <button class="secondary" onclick="clearSendForm()">æ¸…ç©º</button>
                        <button class="secondary" onclick="fillTestMessage()">æµ‹è¯•ä¿¡æ¯</button>
                        <span
                            style="margin-left: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">Ctrl+Enter</span>
                        <div class="response-box" id="sendResponse"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let client = null;
        let messageCount = 0;
        let currentToken = '';
        let clientId = '';
        let messages = []; // æ¶ˆæ¯ç¼“å­˜æ•°ç»„
        const MAX_MESSAGES = 100; // æœ€å¤§ç¼“å­˜æ¶ˆæ¯æ•°
        let confirmCallback = null; // ç¡®è®¤å¯¹è¯æ¡†å›è°ƒ

        function generateClientId() {
            return 'web-' + Math.random().toString(16).substr(2, 8);
        }

        window.onload = function () {
            clientId = localStorage.getItem('mqttClientId');
            if (!clientId) {
                clientId = generateClientId();
                localStorage.setItem('mqttClientId', clientId);
            }

            const savedBrokerUrl = localStorage.getItem('brokerUrl');
            document.getElementById('brokerUrl').value = savedBrokerUrl || 'wss://mqtt.example.com';

            const savedTopic = localStorage.getItem('mqttTopic');
            if (savedTopic) {
                document.getElementById('topic').value = savedTopic;
            }

            // åŠ è½½ç¼“å­˜çš„æ¶ˆæ¯
            loadCachedMessages();

            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                document.getElementById('authTokenInput').value = savedToken;
                authenticate();
            }
        };

        // åŠ è½½ç¼“å­˜çš„æ¶ˆæ¯
        function loadCachedMessages() {
            try {
                const cached = localStorage.getItem('cachedMessages');
                if (cached) {
                    messages = JSON.parse(cached);
                    renderMessages();
                }
            } catch (e) {
                console.error('åŠ è½½ç¼“å­˜æ¶ˆæ¯å¤±è´¥:', e);
                messages = [];
            }
        }

        // ä¿å­˜æ¶ˆæ¯åˆ°ç¼“å­˜
        function saveCachedMessages() {
            try {
                localStorage.setItem('cachedMessages', JSON.stringify(messages));
            } catch (e) {
                console.error('ä¿å­˜ç¼“å­˜æ¶ˆæ¯å¤±è´¥:', e);
            }
        }

        // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
        function renderMessages() {
            const list = document.getElementById('messagesList');
            const emptyState = document.getElementById('emptyState');

            if (messages.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" id="emptyState">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>ç­‰å¾…æ¶ˆæ¯...</p>
                    </div>
                `;
                messageCount = 0;
            } else {
                list.innerHTML = messages.map((msg, idx) => createMessageHTML(msg, idx)).join('');
                messageCount = messages.length;
            }
            document.getElementById('messageCount').textContent = messageCount + ' æ¡';
            updateSelectAllState();
            updateDeleteSelectedBtn();
        }

        // åˆ›å»ºå•æ¡æ¶ˆæ¯çš„ HTML
        function createMessageHTML(msg, idx) {
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '';
            return `
                <div class="message-item" data-idx="${idx}">
                    <label class="custom-checkbox">
                        <input type="checkbox" onchange="onMessageSelect(${idx})" data-idx="${idx}">
                        <span class="checkmark"></span>
                    </label>
                    <div class="message-body">
                        <div class="message-header">
                            <span class="message-title">${escapeHtml(msg.title)}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        <div class="message-topic">${escapeHtml(msg.topic)}</div>
                    </div>
                </div>
            `;
        }

        async function authenticate() {
            const token = document.getElementById('authTokenInput').value.trim();

            if (!token) {
                showAuthError('è¯·è¾“å…¥ Token');
                return;
            }

            try {
                const res = await fetch('/webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ content: '__auth_check__' })
                });

                if (res.status === 429) {
                    showAuthError('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                    return;
                }

                if (res.status === 401) {
                    const data = await res.json().catch(() => ({}));
                    showAuthError(data.message || 'Token éªŒè¯å¤±è´¥');
                    return;
                }

                currentToken = token;
                localStorage.setItem('authToken', token);

                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainContent').classList.add('active');
                document.getElementById('topbarRight').style.display = 'flex';
                document.getElementById('tokenDisplay').textContent = token.substring(0, 6) + '**';

                loadServerStatus();
                showToast('è®¤è¯æˆåŠŸ', 'success');

            } catch (e) {
                showAuthError('è¿æ¥å¤±è´¥: ' + e.message);
            }
        }

        function showAuthError(msg) {
            const box = document.getElementById('authResponse');
            box.style.display = 'block';
            box.className = 'response-box error';
            box.textContent = 'âŒ ' + msg;
        }

        function logout() {
            currentToken = '';
            localStorage.removeItem('authToken');
            if (client) {
                client.end();
                client = null;
            }
            document.getElementById('mainContent').classList.remove('active');
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('topbarRight').style.display = 'none';
            document.getElementById('authResponse').style.display = 'none';
            updateStatus('disconnected', 'ç¦»çº¿');
        }

        async function loadServerStatus() {
            try {
                const res = await fetch('/status');
                const data = await res.json();
                document.getElementById('serverStats').innerHTML = `
                    <span>ğŸ“Š ${data.status}</span>
                    <span>ğŸ‘¥ ${data.clients}</span>
                `;
            } catch (e) {
                document.getElementById('serverStats').innerHTML = '<span style="color: var(--error)">âš ï¸</span>';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        function toggleConnection() {
            if (client && client.connected) {
                disconnect();
            } else {
                connect();
            }
        }

        function connect() {
            const brokerUrl = document.getElementById('brokerUrl').value;
            const topic = document.getElementById('topic').value;

            updateStatus('connecting', 'è¿æ¥ä¸­');

            client = mqtt.connect(brokerUrl, {
                clientId: clientId,
                username: currentToken,
                reconnectPeriod: 5000,
            });

            client.on('connect', () => {
                updateStatus('connected', 'åœ¨çº¿');
                localStorage.setItem('brokerUrl', brokerUrl);
                localStorage.setItem('mqttTopic', topic);
                localStorage.setItem('authToken', currentToken);

                client.subscribe(topic, (err) => {
                    if (err) showToast('è®¢é˜…å¤±è´¥: ' + err.message, 'error');
                });
                loadServerStatus();
            });

            client.on('message', (topic, payload) => {
                try {
                    const msg = JSON.parse(payload.toString());
                    if (msg.content === '__auth_check__') return;
                    addMessage(topic, msg);
                } catch (e) {
                    addMessage(topic, { content: payload.toString() });
                }
            });

            client.on('error', (err) => {
                updateStatus('error', 'é”™è¯¯');
                showToast('MQTT: ' + err.message, 'error');

                const errMsg = (err.message || '').toLowerCase();
                if (errMsg.includes('not authorized') || errMsg.includes('bad user') || errMsg.includes('auth')) {
                    localStorage.removeItem('authToken');
                    showToast('è®¤è¯å¤±è´¥', 'error');
                    logout();
                }
            });

            client.on('close', () => {
                updateStatus('disconnected', 'ç¦»çº¿');
            });

            client.on('reconnect', () => {
                updateStatus('connecting', 'é‡è¿');
            });
        }

        function disconnect() {
            if (client) {
                client.end();
                client = null;
            }
            updateStatus('disconnected', 'ç¦»çº¿');
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const btn = document.getElementById('connectBtn');

            statusText.textContent = text;
            dot.className = 'status-dot';

            if (status === 'connected') {
                dot.classList.add('connected');
                btn.textContent = 'æ–­å¼€';
                btn.classList.add('danger');
            } else {
                btn.textContent = 'è¿æ¥';
                btn.classList.remove('danger');
            }
        }

        function addMessage(topic, msg) {
            const title = msg.title || 'é€šçŸ¥';
            const content = msg.content || JSON.stringify(msg);
            const timestamp = msg.timestamp || new Date().toISOString();

            // æ·»åŠ åˆ°æ¶ˆæ¯æ•°ç»„å¼€å¤´
            messages.unshift({
                topic: topic,
                title: title,
                content: content,
                timestamp: timestamp
            });

            // ä¿æŒæœ€å¤š MAX_MESSAGES æ¡æ¶ˆæ¯
            if (messages.length > MAX_MESSAGES) {
                messages = messages.slice(0, MAX_MESSAGES);
            }

            // ä¿å­˜åˆ°ç¼“å­˜å¹¶é‡æ–°æ¸²æŸ“
            saveCachedMessages();
            renderMessages();

            if (Notification.permission === 'granted') {
                new Notification(title, { body: content });
            }
        }

        // ç¡®è®¤æ¸…ç©ºæ¶ˆæ¯
        function confirmClearMessages() {
            if (messages.length === 0) {
                showToast('æ²¡æœ‰æ¶ˆæ¯å¯æ¸…ç©º', 'error');
                return;
            }
            showConfirm('æ¸…ç©ºæ¶ˆæ¯', `ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨ ${messages.length} æ¡æ¶ˆæ¯å—ï¼Ÿ`, () => {
                messages = [];
                saveCachedMessages();
                renderMessages();
                document.getElementById('selectAllCheckbox').checked = false;
                showToast('å·²æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯', 'success');
            });
        }

        // æ¶ˆæ¯é€‰ä¸­çŠ¶æ€å˜åŒ–
        function onMessageSelect(idx) {
            const item = document.querySelector(`.message-item[data-idx="${idx}"]`);
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
            updateSelectAllState();
            updateDeleteSelectedBtn();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            const checkboxes = document.querySelectorAll('.message-item input[type="checkbox"]');
            const items = document.querySelectorAll('.message-item');
            checkboxes.forEach(cb => cb.checked = selectAll);
            items.forEach(item => {
                if (selectAll) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            updateDeleteSelectedBtn();
        }

        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.message-item input[type="checkbox"]');
            const checkedCount = document.querySelectorAll('.message-item input[type="checkbox"]:checked').length;
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (checkboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // æ›´æ–°åˆ é™¤é€‰ä¸­æŒ‰é’®æ˜¾ç¤º
        function updateDeleteSelectedBtn() {
            // æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º "åˆ é™¤é€‰ä¸­"ï¼Œä¸æ˜¾ç¤ºæ•°å­—é¿å…è§†è§‰æ™ƒåŠ¨
        }

        // ç¡®è®¤åˆ é™¤é€‰ä¸­æ¶ˆæ¯
        function confirmDeleteSelected() {
            const checkedCount = document.querySelectorAll('.message-item input[type="checkbox"]:checked').length;
            if (checkedCount === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ¶ˆæ¯', 'error');
                return;
            }
            showConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkedCount} æ¡æ¶ˆæ¯å—ï¼Ÿ`, () => {
                deleteSelectedMessages();
            });
        }

        // åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
        function deleteSelectedMessages() {
            const checkedBoxes = document.querySelectorAll('.message-item input[type="checkbox"]:checked');
            const indicesToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.idx));
            // ä»å¤§åˆ°å°æ’åºï¼Œé¿å…åˆ é™¤æ—¶ç´¢å¼•å˜åŒ–
            indicesToDelete.sort((a, b) => b - a);
            indicesToDelete.forEach(idx => {
                messages.splice(idx, 1);
            });
            saveCachedMessages();
            renderMessages();
            document.getElementById('selectAllCheckbox').checked = false;
            showToast(`å·²åˆ é™¤ ${indicesToDelete.length} æ¡æ¶ˆæ¯`, 'success');
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        }

        // éšè—ç¡®è®¤å¯¹è¯æ¡†
        function hideConfirm(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('confirmModal').classList.remove('active');
                confirmCallback = null;
            }
        }

        // æ‰§è¡Œç¡®è®¤æ“ä½œ
        function executeConfirm() {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirm();
        }

        async function sendMessage() {
            const title = document.getElementById('sendTitle').value.trim();
            const content = document.getElementById('sendContent').value.trim();
            const topic = document.getElementById('sendTopic').value.trim();

            if (!content) {
                showToast('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            const btn = document.getElementById('sendBtn');
            const responseBox = document.getElementById('sendResponse');

            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';

            try {
                const body = { title: title || 'é€šçŸ¥', content };
                if (topic) body.topic = topic;

                const res = await fetch('/webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify(body)
                });

                responseBox.style.display = 'block';

                if (res.status === 429) {
                    responseBox.className = 'response-box error';
                    responseBox.textContent = 'âŒ è¯·æ±‚è¿‡äºé¢‘ç¹';
                    return;
                }

                if (res.status === 401) {
                    responseBox.className = 'response-box error';
                    responseBox.textContent = 'âŒ è®¤è¯å¤±è´¥';
                    logout();
                    return;
                }

                const data = await res.json();

                if (data.success) {
                    responseBox.className = 'response-box success';
                    responseBox.textContent = `âœ… ${data.message} (${data.clients} å®¢æˆ·ç«¯)`;
                    showToast('å‘é€æˆåŠŸ', 'success');

                    document.getElementById('sendTitle').value = '';
                    document.getElementById('sendContent').value = '';

                    loadServerStatus();
                } else {
                    responseBox.className = 'response-box error';
                    responseBox.textContent = `âŒ ${data.message}`;
                }
            } catch (e) {
                responseBox.style.display = 'block';
                responseBox.className = 'response-box error';
                responseBox.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'å‘é€æ¶ˆæ¯';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                if (document.getElementById('tab-send').classList.contains('active')) {
                    sendMessage();
                }
            }
        });

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        function clearSendForm() {
            document.getElementById('sendTitle').value = '';
            document.getElementById('sendContent').value = '';
            document.getElementById('sendTopic').value = '';
            document.getElementById('sendResponse').style.display = 'none';
        }

        function fillTestMessage() {
            const now = new Date();
            const time = now.toLocaleTimeString();
            const titles = ['ç³»ç»Ÿé€šçŸ¥', 'æµ‹è¯•æ¶ˆæ¯', 'æœåŠ¡æé†’', 'çŠ¶æ€æ›´æ–°', 'è°ƒè¯•ä¿¡æ¯'];
            const contents = [
                'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œç”¨äºéªŒè¯æ¨é€åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\næ—¶é—´ï¼š' + time,
                'æœåŠ¡è¿è¡Œæ­£å¸¸ï¼Œæ‰€æœ‰ç»„ä»¶çŠ¶æ€è‰¯å¥½ã€‚\næ—¶é—´ï¼š' + time,
                'æ‚¨æœ‰ä¸€æ¡æ–°çš„é€šçŸ¥æ¶ˆæ¯ï¼Œè¯·åŠæ—¶æŸ¥çœ‹ã€‚\næ—¶é—´ï¼š' + time,
                'æµ‹è¯•å¤šè¡Œå†…å®¹ï¼š\nç¬¬ä¸€è¡Œ\nç¬¬äºŒè¡Œ\nç¬¬ä¸‰è¡Œ\næ—¶é—´ï¼š' + time,
                'ğŸ‰ æ­å–œï¼æ¶ˆæ¯æ¨é€æµ‹è¯•æˆåŠŸï¼\næ—¶é—´ï¼š' + time
            ];
            const idx = Math.floor(Math.random() * titles.length);
            document.getElementById('sendTitle').value = titles[idx];
            document.getElementById('sendContent').value = contents[idx];
            document.getElementById('sendResponse').style.display = 'none';
        }

        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function hideHelp(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('helpModal').classList.remove('active');
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideHelp();
                hideConfirm();
            }
        });
    </script>
</body>

</html>