.PHONY: build build-release docker docker-release docker-rebuild docker-clean clean help

# é»˜è®¤ç›®æ ‡
help:
	@echo "Android Notice Client æ„å»ºå‘½ä»¤:"
	@echo ""
	@echo "  make build          - æ„å»º Debug APK (éœ€è¦æœ¬åœ° Android SDK)"
	@echo "  make build-release  - æ„å»º Release APK"
	@echo "  make docker         - ä½¿ç”¨ Docker æ„å»º Debug APK"
	@echo "  make docker-release - ä½¿ç”¨ Docker æ„å»º Release APK"
	@echo "  make docker-rebuild - å¼ºåˆ¶é‡æ–°æ„å»º Docker é•œåƒ"
	@echo "  make docker-clean   - æ¸…ç† Docker é•œåƒ"
	@echo "  make clean          - æ¸…ç†æ„å»ºäº§ç‰©"
	@echo ""
	@echo "ç‰ˆæœ¬å‚æ•°:"
	@echo "  VERSION_NAME=1.0.0  - ç‰ˆæœ¬åç§°"
	@echo "  VERSION_CODE=1      - ç‰ˆæœ¬å·"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make docker-release KEYSTORE_PASSWORD=xxx VERSION_NAME=1.0.0 VERSION_CODE=1"
	@echo ""

# æœ¬åœ°æ„å»º (éœ€è¦ Android SDK)
build:
	./gradlew assembleDebug
	@echo ""
	@echo "âœ… Debug APK å·²ç”Ÿæˆ:"
	@ls -lh app/build/outputs/apk/debug/*.apk

build-release:
	./gradlew assembleRelease
	@echo ""
	@echo "âœ… Release APK å·²ç”Ÿæˆ:"
	@ls -lh app/build/outputs/apk/release/*.apk 2>/dev/null || echo "âš ï¸  éœ€è¦é…ç½®ç­¾å"

# ç‰ˆæœ¬ä¿¡æ¯ (å¯é€šè¿‡å‚æ•°ä¼ å…¥)
VERSION_NAME ?= 0.0.0
VERSION_CODE ?= 1

# ç¼“å­˜ç›®å½• (åŠ é€Ÿåç»­æ„å»º)
GRADLE_CACHE ?= $(PWD)/.gradle-cache
PROJECT_GRADLE ?= $(PWD)/.gradle
ANDROID_HOME_CACHE ?= $(PWD)/.android
KOTLIN_CACHE ?= $(PWD)/.kotlin

# æ„å»ºå‚æ•°
GRADLE_VERSION_ARGS := $(if $(VERSION_NAME),-PversionName=$(VERSION_NAME),) $(if $(VERSION_CODE),-PversionCode=$(VERSION_CODE),)

# Docker æ„å»º (æ— éœ€æœ¬åœ° Android SDK)
docker:
	@echo "ğŸ³ ä½¿ç”¨ Docker æ„å»º..."
	@if docker image inspect notice-android-builder >/dev/null 2>&1; then \
		echo "âœ“ é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"; \
	else \
		echo "â†’ æ„å»ºé•œåƒ..."; \
		docker build -t notice-android-builder .; \
	fi
	@mkdir -p $(GRADLE_CACHE) $(PROJECT_GRADLE) $(ANDROID_HOME_CACHE) $(KOTLIN_CACHE)
	@echo ""
	@echo "ğŸ“¦ æ„å»º APK (æºç +ç¼“å­˜æŒ‚è½½)..."
	docker run --rm \
		-u $(shell id -u):$(shell id -g) \
		-e ANDROID_USER_HOME=/android-home \
		-v "$(PWD)/app:/app/app" \
		-v "$(GRADLE_CACHE):/gradle-cache" \
		-v "$(PROJECT_GRADLE):/app/.gradle" \
		-v "$(ANDROID_HOME_CACHE):/android-home" \
		-v "$(KOTLIN_CACHE):/app/.kotlin" \
		notice-android-builder \
		./gradlew assembleDebug --no-daemon --console=plain $(GRADLE_VERSION_ARGS)
	@echo ""
	@echo "âœ… Debug APK å·²ç”Ÿæˆ:"
	@ls -lh app/build/outputs/apk/debug/*.apk

# ç­¾åé…ç½® (é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ï¼Œé»˜è®¤ä» key æ–‡ä»¶è¯»å–å¯†ç )
KEYSTORE_PASSWORD ?= $(shell cat key 2>/dev/null || echo "")
KEY_PASSWORD ?= $(KEYSTORE_PASSWORD)
KEY_ALIAS ?= notice

# Docker æ„å»º Release APK
docker-release:
	@echo "ğŸ³ ä½¿ç”¨ Docker æ„å»º Release..."
	@if [ -z "$(KEYSTORE_PASSWORD)" ]; then \
		echo "âŒ è¯·è®¾ç½®ç­¾åå¯†ç :"; \
		echo "   make docker-release KEYSTORE_PASSWORD=xxx"; \
		echo "   (KEY_PASSWORD é»˜è®¤ä¸ KEYSTORE_PASSWORD ä¸€è‡´)"; \
		exit 1; \
	fi
	@if docker image inspect notice-android-builder >/dev/null 2>&1; then \
		echo "âœ“ é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"; \
	else \
		echo "â†’ æ„å»ºé•œåƒ..."; \
		docker build -t notice-android-builder .; \
	fi
	@mkdir -p $(GRADLE_CACHE) $(PROJECT_GRADLE) $(ANDROID_HOME_CACHE) $(KOTLIN_CACHE)
	@echo ""
	@echo "ğŸ“¦ æ„å»º Release APK..."
	docker run --rm \
		-u $(shell id -u):$(shell id -g) \
		-e ANDROID_USER_HOME=/android-home \
		-e KEYSTORE_PASSWORD="$(KEYSTORE_PASSWORD)" \
		-e KEY_PASSWORD="$(KEY_PASSWORD)" \
		-e KEY_ALIAS="$(KEY_ALIAS)" \
		-v "$(PWD)/app:/app/app" \
		-v "$(PWD)/release.keystore:/app/release.keystore:ro" \
		-v "$(GRADLE_CACHE):/gradle-cache" \
		-v "$(PROJECT_GRADLE):/app/.gradle" \
		-v "$(ANDROID_HOME_CACHE):/android-home" \
		-v "$(KOTLIN_CACHE):/app/.kotlin" \
		notice-android-builder \
		./gradlew assembleRelease --no-daemon --console=plain $(GRADLE_VERSION_ARGS)
	@echo ""
	@echo "âœ… Release APK å·²ç”Ÿæˆ:"
	@ls -lh app/build/outputs/apk/release/*.apk

# å¼ºåˆ¶é‡æ–°æ„å»º Docker é•œåƒ (ä¸ä½¿ç”¨ç¼“å­˜)
docker-rebuild:
	@echo "ğŸ”¨ å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒ (--no-cache)..."
	docker build --no-cache -t notice-android-builder .
	@echo "âœ… é•œåƒé‡å»ºå®Œæˆ"

# æ¸…ç†
clean:
	./gradlew clean 2>/dev/null || true
	rm -rf app/build
	rm -f app-debug.apk
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ¸…ç† Docker é•œåƒ
docker-clean:
	docker rmi notice-android-builder 2>/dev/null || true
	@echo "âœ… Docker é•œåƒå·²æ¸…ç†"
